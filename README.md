# Bash, awk, sed, grep и другие

Т.к. фактически в тестовой системе отсутствует nginx, который мог бы генерить логи на основе обращений к нему, то используется предложенный в материалах ДЗ срез лога (access-4560-644067.log). Для полноценного теста работы скрипта (logchecker.sh) необходимо постепенное наполнение лога, иначе при первом разовом его прочтении скриптом, дальнейшие попытки будут выглядеть как проверка лога с отсутствием посещаемости. Поэтому было решено реализовать эмуляцию наполнения лога, порционно выдергивая последовательные строки из оригинального файла и помещая их в лог, который будет считывать logchecker. Таким образом, задача решается посредством двух скриптов: основного - logchecker.sh и вспомогательного - emul_log_writer.sh. Оба скрипта запускаются кроном, но не одновременно, а с небольшим смещением по времени, чтобы у основного скрипта была возможность зафиксировать ситуации отсутствия посещений.

## Расписание в crontab
В crontab внесено два варианта работы скриптов:
1. Ускоренная проверка логов, чтение происходит раз в три минуты. Наполнение раз в две минуты.
2. Как прописано в задании: чтение лога происходит в пятую минуту каждого часа. Наполнение происходит раз в 58 минут.
При инициации системы активна первая опция, чтобы скрипт можно было протестировать в ускоренном режиме.

## Описание структуры каталога скрипта
Рабочей директорией скриптов является /vagrant/script В ней имеются:
* logchecker.sh - запускаемый файл скрипта
* emul_log_writing.sh - скрипт, наполняющий файл лога
* fixline.log - хранит номер последней считанной строки для emul_log_writing.sh
* lastline.log - хранит номер последней считанной строки для logchecker.sh
* lastdate.txt - хранит последнюю отметку времени для logchecker.sh
* last_message.txt - хранит последний отчет, отправленный logchecker.sh на почту
* mail_addr - содержит почтовый адрес, куда будут отправляться отчеты
##### Единственная настройка, которую необходимо выполнить вручную перед запуском тестовой системы
- это задать адрес почты, на которую будут отправляться отчеты. Настройка выглядит так:
`MAILADDR=mail@domain.com`
Файл mail_addr уже содержит параметр и знак равно, неоходимо только задать адрес почты после знака равно.
На момент запуска скрипта адрес уже должен быть прописан, поэтому целесообразно сделать это до поднятия виртуалки.

## Описание структуры скрипта
#### Переменные:
* IP_PATTERN - хранит регулярное выражение для выявления IP-адреса
* PIDFILE - путь к файлу PID.
* LOGFILE - путь к логу
* MSG - путь к файлу, в котором формируется отчет для последующей отправки
* READ_ITER - хранит строки лога, обрабатываемые скриптом в данную итерацию
* LAST_LINE_STORE - путь к файлу, где хранится номер последней строки, считанной в последнюю итерацию
* LAST_LINE - переменная, хранящая номер последней строки логфайла за предыдущую итерацию, хранится в файле LAST_LINE_STORE
* LASTDATE - хранит дату последней итерации
* TOTAL_LINES - хранит число строк содержащихся в логе в текущей итерации.
* MAILADDR - хранит адрес реципиента, куда будет направлено письмо. Лежит в файле mail_addr.

#### Функции
* check_PID - проверяет наличие PID-файла при запуске
* put_PID - создает PID-файл
* kill_PID_on_exit
* check_actual_accesslog - проверяет наличие самого логфайла и наличие данных в нем. В случае отсуствия того или другого, отправляет соответствующее сообщение на почту
* tail_from_last_line - получает срез строк лога от последней строки прочитанной в предыдущую итерацию, до последней строки.
* save_last_line - помещает текущее количество строк в логфайле в переменную LAST_LINE и сохраняет в файл LAST_LINE_STORE
* most_frequent_client_IP - собирает 10 наиболее частых ip посетителей
* most_frequent_URL - собирает количество посещений определенных URL
* all_errors - собирает ошибки 4хх и 5хх
* all_responses - собирает количество ответов
* rotate_date - сохраняет дату текущего запуска скрипта в LASTDATE
* make_letter - производит сборку тела письма для последующей отправки вызова функций most_frequent_client_IP, most_frequent_URL, all_errors, all_responses, последовательно дописывая выводы всех перечисленных функций в файл MSG
* send_letter - производит отправку письма, переименовывает файл MSG в last_message.txt. Временной срезу, закоторый были проанализирован лог, помещается в тему письма. Адрес реципиента берется из файла mail_addr.

#### Логика выполнения скрипта
При запуске скрипта вышеописанные функции запускаются в следующем порядке:
1. check_PID
2. put_PID
3. make_letter
4. send_letter
5. save_last_line
6. rotate_date